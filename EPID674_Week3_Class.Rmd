---
title: "EPID674 Epidemiologic Data Analysis using R"
subtitle: "Descriptive Statistics, Tables, Misc."
author: "Kelly Bakulski"
date: "Last compiled on `r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # This is how you set options for all chunks of code
```

## Chapter 3, Descriptive Statistics, Tables, Misc.

# Install new packages

```{r install packages, eval=FALSE}

# Install packages. Do this only once.
# We have this completed for you on Cloud, so you do not need to run this.
options(repos="https://cran.rstudio.com" )
install.packages("tidyverse")
install.packages("here")
install.packages("gtsummary")
install.packages("flextable")

# To avoid installing every time: change set up in curly brackets to eval=FALSE
```

# Set up: Query the current R environment, load relevant packages, load dataset created in Week 2

```{r packages}

search() # list the packages, environments, or data frames
ls() # list the objects

##### Load these packages for the current session
library(tidyverse)
library(here)
library(gtsummary)
library(flextable)

sessionInfo() # record the versions of packages used in the current session

# Load saved NHANES dataset from Week 2
load(here(("nhanes_dataset.rda")))
```


# Data description functions, numeric variables

```{r descriptives_numeric_variable}

# Base R method - quick, good for one variable at a time
summary(nhanes_dataset$RIDAGEYR)
# For missing values, include na.rm = TRUE:
sd(nhanes_dataset$LBXIRN, na.rm = TRUE)

# Tidyverse method - more code, but can be used to get summary statistics on multiple variables
nhanes_dataset %>%
  summarise(age_min = min(RIDAGEYR),
            age_25_quart = quantile(RIDAGEYR, probs = 0.25),
            age_mean = mean(RIDAGEYR),
            age_median = median(RIDAGEYR),
            age_75_quart = quantile(RIDAGEYR, probs = 0.75),
            age_iqr = IQR(RIDAGEYR),
            age_max = max(RIDAGEYR))

# Calculating statistics by groups - tidyverse
# Note: good practice to add ungroup() after using it to avoid the dataset staying grouped
nhanes_dataset %>%
  group_by(sex) %>%
  summarise(age_min = min(RIDAGEYR),
            age_25_quart = quantile(RIDAGEYR, probs = 0.25),
            age_mean = mean(RIDAGEYR),
            age_median = median(RIDAGEYR),
            age_75_quart = quantile(RIDAGEYR, probs = 0.75),
            age_iqr = IQR(RIDAGEYR),
            age_max = max(RIDAGEYR)) %>%
  ungroup()

# Do activity with this example
nhanes_dataset %>%
  group_by(sex) %>%
  summarise(age_mean = mean(RIDAGEYR),
            pir_mean = mean(INDFMPIR, na.rm = TRUE)) %>%
  ungroup()
```

# Calculate descriptive statistics on a categorical variable

```{r categorical_variable_descriptives}

# Base R method
table(nhanes_dataset$race_eth)
table(nhanes_dataset$race_eth, nhanes_dataset$sex)
```

# Create a publication-formatted table

```{r}
# Univariate table using gtsummary package
nhanes_dataset %>%
  select(-SEQN,
         -SDMVSTRA,
         -SDMVPSU,
         -RIASEX,
         -RIDRETH1,
         -cut_groups) %>% #drop SEQN and survey variables so we don't get summary statistics for the identifiers or weights
  tbl_summary()


# Bivariate table by sex using gtsummary - will take about 5 seconds to run
bivar_nhanes <- nhanes_dataset %>%
  select(-SEQN,
         -SDMVSTRA,
         -SDMVPSU,
         -RIASEX,
         -RIDRETH1,
         -cut_groups,
         -LBXWBCSI,
         -LBDLYMNO,
         -LBDNENO,
         -URXUAS,
         -LBXCOT,
         -LBXBCD,
         -LBXBPB) %>%
  tbl_summary(by = sex, #stratify by sex
              label = list(RIDAGEYR    ~ "Age (years)", #update the variable names
                           race_eth    ~ "Race/Ethnicity",
                           INDFMPIR    ~ "Poverty-Income Ratio",
                           LBXRBCSI    ~ "Red Blood Cell Count (million cells/uL)",
                           LBXIRN      ~ "Iron (ug/dL)",
                           iron_status ~ "Iron Status",
                           nlr         ~ "Neutrophil:Lymphocyte Ratio"),
              statistic = list(all_continuous() ~ "{mean} ({sd})", #use mean and standard deviation for continuous variables
                               all_categorical() ~ "{n} ({p}%)"),  #use count and percentage for categorical variables
              digits = list(all_categorical() ~ c(0, 1), #adds no decimal places to counts and one decimal to percentages
                            all_continuous() ~ 1), #adds one decimal place to mean and sd values
              missing_text = "Missing (n)"
              ) %>%
  add_p() %>% #compares male vs female, does not include overall in p-value calculation
  add_overall() %>% #adds column with non-stratified summary statistics
  modify_header(label ~ "**Variable**") %>% #the asterisks bold the label
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Sex**") %>%
  bold_labels()

#View table
bivar_nhanes


# Save the table as a Word document - some formatting such as bold headers will be lost
bivar_nhanes %>%
  as_flex_table() %>%
  save_as_docx(path = here("summary_stats_table.docx")) #Export the table to Word using flextable package
```


# Do Exercise 2A


# Create a subset of the dataset

```{r subset}

# Practice subset: Keep only the female participants
nhanes_subset <- nhanes_dataset %>%
  filter(sex == "Female")

# Keep only the participants who are iron deficient and older than 60 years using filter()
nhanes_subset <- nhanes_dataset %>%
  filter(iron_status == "Deficient" & RIDAGEYR >= 60)

# How many participants have complete data?
nhanes_subset %>%
  na.omit() %>% #exclude any participants with missing data
  dim() #what are the dimensions after excluding missing data?
```



# Do Exercise 2B




# Ordering data

```{r}

#order by sex and then age
nhanes_ordered <- nhanes_dataset %>%
  arrange(sex, RIDAGEYR)
```

# Ready to do Exercise 3A



# Check function default settings for handling missing values

```{r check_default_missing}
### How do functions handle missing values?

#calculate a correlation between age and iron concentration
cor(nhanes_ordered$RIDAGEYR, nhanes_ordered$LBXIRN)
cor(nhanes_ordered$RIDAGEYR, nhanes_ordered$LBXIRN, use="complete.obs")

#calculate summary statistics on iron
summary(nhanes_ordered$LBXIRN)

#calculate the mean of iron
mean(nhanes_ordered$LBXIRN)
mean(nhanes_ordered$LBXIRN, na.rm = TRUE)
#note the na.omit - remove all rows that include NAs
mean(na.omit(nhanes_ordered$LBXIRN))
```


# Exclude some data 

```{r}

# Check the original counts 
table(nhanes_ordered$RIDAGEYR, useNA = "always")

# Exclude data for participants who are less than 1 years old
nhanes_age_1_85 <- nhanes_ordered %>%
  mutate(age = na_if(RIDAGEYR, 0)) %>% #make all ages of 0 missing
  drop_na(age) #if there is a missing in RIDAGEYR, drop that participant row (will drop participants who were age 0)

# Check new counts
table(nhanes_age_1_85$age, useNA = "always")

# Why is NA still 0?
```



# Try compiling results with a for loop

```{r for_loop}
# First prep the output dataset - set up blank columns
out <- data.frame(matrix(nrow = ncol(nhanes_ordered), ncol = 3))

#set the column names for the dataframe
colnames(out) <- c("variable", "mean", "sd")

#pull the column names from nhanes_ordered and set them as the values for the first column
out[, 1] <- colnames(nhanes_ordered)

# Then initiate the loop
for (i in 1:ncol(nhanes_ordered)) {
  out[i, 2] <- mean(as.numeric(nhanes_ordered[, i]), na.rm = TRUE)
  out[i, 3] <- sd(as.numeric(nhanes_ordered[, i]), na.rm = TRUE)
}
out

# Why do some variables have a mean of NA?
```


# Date and Time

# Input variable formats, convert to desired format

```{r date_format}
# create some dates to use in this exercise
bdays <- c("11/2/1959", "1/1/1970")
bdays
# convert to Julian dates
bdays.julian <- as.Date(bdays, format = "%m/%d/%Y")
bdays.julian

as.numeric(bdays.julian)

bdays.am <- format(bdays.julian, "%b %d, %Y")
bdays.am

# day of the week
format(bdays.julian, "%a-%d%b%y")
weekdays(bdays.julian)
```

# Calculate age as of today's date

```{r age_from_date}
date.today <- Sys.Date() # Sys.time or Sys.Date: Current time/Date
date.today

agecomp <- (date.today - bdays.julian) / 365.25
agecomp

agecomp2 <- trunc(as.numeric(agecomp))


# create data frame
bd <- data.frame(Birthday = bdays, Standard = bdays.julian, Julian = as.numeric(bdays.julian), Age = agecomp2)
bd
```

# Paste function

```{r paste}
# combine (paste) two or more variables that are parts of date
day1 <- c("12", "13", "14")
month1 <- c("07", "08", "12")
year1 <- c("1980", "2000", "2010")
paste(day1, month1, year1)

as.Date(paste(day1, month1, year1), "%d %m %Y")
```

# Ready to do Exercise 3B



# Remember to save your R script!

# To exit R

```{r exit, eval=F}
# q()
## if you close R, you will be asked to save your workspace image
```